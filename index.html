<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Rekon CRM Hitachi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --hitachi: #6c5ce7;
            --failed: #e74c3c;
            --stored: #27ae60;
            --taken: #3498db;
            --replenish: #9b59b6;
            --denom50: #f39c12;
            --denom100: #8e44ad;
            --remaining: #16a085;
            --tid: #2c3e50;
        }
        
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
            padding-bottom: 40px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: none;
            border-radius: 12px;
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .header {
            background: linear-gradient(135deg, var(--hitachi), #3498db);
            color: white;
            padding: 30px 0;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .instructions {
            background-color: #e9ecef;
            border-left: 4px solid var(--hitachi);
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 0 8px 8px 0;
        }
        .footer {
            margin-top: 30px;
            padding: 20px;
            background-color: #343a40;
            color: white;
            text-align: center;
            border-radius: 8px;
        }
        .btn-hitachi {
            background-color: var(--hitachi);
            border-color: var(--hitachi);
            color: white;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .btn-hitachi:hover {
            background-color: #5649c0;
            border-color: #5649c0;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 40px 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f8f9fa;
        }
        .upload-area:hover {
            border-color: var(--hitachi);
            background-color: #f0f7ff;
            transform: translateY(-2px);
        }
        .file-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .file-item {
            padding: 10px 15px;
            background-color: #f1f3f5;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        .file-item:hover {
            background-color: #e9ecef;
        }
        .file-item .file-name {
            flex-grow: 1;
            margin-right: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 500;
        }
        .result-card {
            border-radius: 12px;
            overflow: hidden;
        }
        .result-header {
            color: white;
            padding: 18px;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .result-body {
            padding: 25px;
        }
        .result-value {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin: 15px 0;
            font-family: monospace;
            color: #2c3e50;
        }
        .result-count {
            text-align: center;
            font-size: 1.1rem;
            color: #6c757d;
            font-weight: 500;
        }
        #failedHeader {
            background-color: var(--failed);
        }
        #storedHeader {
            background-color: var(--stored);
        }
        #takenHeader {
            background-color: var(--taken);
        }
        #replenishHeader {
            background-color: var(--replenish);
        }
        #denom50Header {
            background-color: var(--denom50);
        }
        #denom100Header {
            background-color: var(--denom100);
        }
        #remainingHeader {
            background-color: var(--remaining);
        }
        #tidHeader {
            background-color: var(--tid);
        }
        .keyword {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.9rem;
            background-color: #e9ecef;
            font-weight: 600;
        }
        .progress {
            height: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .amount-example {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid var(--hitachi);
            margin: 8px 0;
        }
        .highlight {
            background-color: #fff3cd;
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        .calculation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            font-size: 0.95rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        .calculation-table th, .calculation-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .calculation-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        .calculation-table tr:last-child {
            font-weight: bold;
            background-color: #e9ecef;
        }
        .replenish-result {
            font-size: 1.6rem;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            margin-top: 25px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            border: 2px dashed var(--replenish);
        }
        .bg-purple {
            background-color: var(--replenish) !important;
        }
        .debug-info {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
            margin-top: 15px;
            font-size: 0.85rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .file-content {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            margin-top: 15px;
            font-size: 0.8rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .note-box {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-top: 15px;
            border-radius: 0 8px 8px 0;
            font-size: 0.95rem;
        }
        .denom-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        .denom-table th, .denom-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .denom-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .remaining-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        .remaining-table th, .remaining-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .remaining-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .remaining-table tr:last-child {
            font-weight: bold;
            background-color: #e9ecef;
        }
        .tid-value {
            font-size: 1.8rem;
            font-weight: bold;
            text-align: center;
            margin: 15px 0;
            font-family: monospace;
            color: #2c3e50;
            letter-spacing: 2px;
        }
        .section-title {
            border-left: 4px solid var(--hitachi);
            padding-left: 15px;
            margin: 30px 0 20px 0;
            font-weight: 600;
            color: #2c3e50;
        }
        .badge {
            font-weight: 500;
            padding: 6px 10px;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header text-center">
            <h1>Aplikasi Rekon CRM Hitachi</h1>
        </div>

        <!-- Instructions -->
        <div class="instructions">
            <h4><i class="fas fa-info-circle me-2"></i>Petunjuk Penggunaan</h4>
            <ol class="mb-0">
                <li>Potong EJ Periode RPL dari COUNTERS CLEARED </li>
                <li>Upload file <span class="keyword">.jrn</span> atau <span class="keyword">.txt</span> dari CRM Hitachi (bisa multiple files)</li>
                <li>Untuk setiap keyword yang ditemukan, aplikasi akan mencari nilai amount terdekat</li>
            </ol>
          </div>

        <div class="row">
            <!-- Upload Section -->
            <div class="col-lg-5">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Upload File</h5>
                    </div>
                    <div class="card-body">
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt fa-3x mb-3" style="color: var(--hitachi);"></i>
                            <h5>Drop file di sini atau klik untuk memilih</h5>
                            <p class="text-muted">Format file: .jrn atau .txt (multiple files supported)</p>
                            <button class="btn btn-hitachi mt-2">
                                <i class="fas fa-file-upload me-2"></i>Pilih File
                            </button>
                        </div>
                        <input type="file" id="fileInput" multiple accept=".jrn,.txt" style="display: none;">
                        
                        <div id="fileListContainer" class="d-none">
                            <h6 class="mt-4">File yang diupload:</h6>
                            <div class="file-list" id="fileList">
                                <!-- File list will be populated here -->
                            </div>
                        </div>
                        
                        <div class="progress d-none" id="progressBar">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                        
                        <button id="processBtn" class="btn btn-hitachi w-100 mt-3 d-none">
                            <i class="fas fa-cogs me-2"></i>Proses Rekonsiliasi
                        </button>
                    </div>
                </div>
                
                <!-- TID Result -->
                <div class="card result-card mt-4">
                    <div class="result-header" id="tidHeader">
                        <i class="fas fa-id-card me-2"></i>CRM TID
                    </div>
                    <div class="result-body text-center">
                        <div class="tid-value" id="tidValue">-</div>
                        <div class="result-count">ATM ID ditemukan</div>
                    </div>
                </div>

                <!-- File Content Preview -->
                <div class="card mt-4 d-none" id="filePreviewCard">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Pratinjau File</h5>
                    </div>
                    <div class="card-body">
                        <div id="filePreview" class="file-content">
                            <!-- File content will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="col-lg-7">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card result-card">
                            <div class="result-header" id="failedHeader">
                                <i class="fas fa-times-circle me-2"></i>Host Store: Failed
                            </div>
                            <div class="result-body">
                                <div class="result-value" id="failedTotal">Rp 0</div>
                                <div class="result-count" id="failedCount">0 transaksi</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card result-card">
                            <div class="result-header" id="storedHeader">
                                <i class="fas fa-check-circle me-2"></i>Host Store: Stored
                            </div>
                            <div class="result-body">
                                <div class="result-value" id="storedTotal">Rp 0</div>
                                <div class="result-count" id="storedCount">0 transaksi</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card result-card">
                            <div class="result-header" id="takenHeader">
                                <i class="fas fa-money-bill-wave me-2"></i>Cash Taken
                            </div>
                            <div class="result-body">
                                <div class="result-value" id="takenTotal">Rp 0</div>
                                <div class="result-count" id="takenCount">0 transaksi</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card result-card">
                            <div class="result-header" id="replenishHeader">
                                <i class="fas fa-boxes me-2"></i>Replenishment
                            </div>
                            <div class="result-body">
                                <div class="result-value" id="replenishTotal">Rp 0</div>
                                <div class="result-count" id="replenishCount">Init Amount ditemukan</div>
                            </div>
                        </div>
                    </div>
                </div>

                <h4 class="section-title">Detail Lembar per Denominasi</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card result-card">
                            <div class="result-header" id="denom50Header">
                                <i class="fas fa-money-bill me-2"></i>Denom 50,000
                            </div>
                            <div class="result-body">
                                <div class="result-value" id="denom50Total">0</div>
                                <div class="result-count" id="denom50Count">0 lembar</div>
                                
                                <table class="denom-table">
                                    <tr>
                                        <th>Sumber</th>
                                        <th>Lembar</th>
                                    </tr>
                                    <tr>
                                        <td>Replenish</td>
                                        <td id="denom50Replenish">0</td>
                                    </tr>
                                    <tr>
                                        <td>Stored Count</td>
                                        <td id="denom50Stored">0</td>
                                    </tr>
                                    <tr>
                                        <td>Dispense Count</td>
                                        <td id="denom50Dispense">0</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card result-card">
                            <div class="result-header" id="denom100Header">
                                <i class="fas fa-money-bill me-2"></i>Denom 100,000
                            </div>
                            <div class="result-body">
                                <div class="result-value" id="denom100Total">0</div>
                                <div class="result-count" id="denom100Count">0 lembar</div>
                                
                                <table class="denom-table">
                                    <tr>
                                        <th>Sumber</th>
                                        <th>Lembar</th>
                                    </tr>
                                    <tr>
                                        <td>Replenish</td>
                                        <td id="denom100Replenish">0</td>
                                    </tr>
                                    <tr>
                                        <td>Stored Count</td>
                                        <td id="denom100Stored">0</td>
                                    </tr>
                                    <tr>
                                        <td>Dispense Count</td>
                                        <td id="denom100Dispense">0</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <h4 class="section-title">Sisa Lembar (Remaining)</h4>
                <div class="card result-card">
                    <div class="result-header" id="remainingHeader">
                        <i class="fas fa-calculator me-2"></i>Hasil Perhitungan Sisa Lembar
                    </div>
                    <div class="result-body">
                        <table class="remaining-table">
                            <thead>
                                <tr>
                                    <th>Denominasi</th>
                                    <th>Replenish</th>
                                    <th>Stored Count</th>
                                    <th>Dispense Count</th>
                                    <th>Sisa Lembar</th>
                                    <th>Formula</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>50,000</td>
                                    <td id="remaining50Replenish">0</td>
                                    <td id="remaining50Stored">0</td>
                                    <td id="remaining50Dispense">0</td>
                                    <td id="remaining50Total" class="fw-bold">0</td>
                                    <td>Replenish + Stored - Dispense</td>
                                </tr>
                                <tr>
                                    <td>100,000</td>
                                    <td id="remaining100Replenish">0</td>
                                    <td id="remaining100Stored">0</td>
                                    <td id="remaining100Dispense">0</td>
                                    <td id="remaining100Total" class="fw-bold">0</td>
                                    <td>Replenish + Stored - Dispense</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calculation Results -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Hasil Perhitungan Rekonsiliasi</h5>
                    </div>
                    <div class="card-body">
                        <table class="calculation-table">
                            <thead>
                                <tr>
                                    <th>Keterangan</th>
                                    <th>Nilai</th>
                                    <th>Keterangan Formula</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Init Amount (dari Replenishment)</td>
                                    <td id="calcInitAmount">Rp 0</td>
                                    <td>Nilai awal dari INIT AMOUNT: (hanya yang pertama)</td>
                                </tr>
                                <tr>
                                    <td>Host Store: Failed (Setor Tunai Gagal)</td>
                                    <td id="calcFailed">+ Rp 0</td>
                                    <td>Ditambahkan ke Init Amount</td>
                                </tr>
                                <tr>
                                    <td>Host Store: Stored (Setor Tunai Berhasil)</td>
                                    <td id="calcStored">+ Rp 0</td>
                                    <td>Ditambahkan ke Init Amount</td>
                                </tr>
                                <tr>
                                    <td>Cash Taken (Tarik Tunai)</td>
                                    <td id="calcTaken">- Rp 0</td>
                                    <td>Dikurangkan dari Init Amount</td>
                                </tr>
                                <tr>
                                    <td>Hasil Rekonsiliasi</td>
                                    <td id="calcResult">Rp 0</td>
                                    <td>Init Amount + Failed + Stored - Taken</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="replenish-result">
                            <i class="fas fa-check-circle me-2 text-success"></i>
                            <span>Hasil Akhir Rekonsiliasi: </span>
                            <span id="finalResult">Rp 0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction Details -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Detail Transaksi</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Jenis</th>
                                        <th>File</th>
                                        <th>Line</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionDetails">
                                    <!-- Transaction details will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug Info -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-bug me-2"></i>Debug Information</h5>
                    </div>
                    <div class="card-body">
                        <div id="debugInfo" class="debug-info">
                            Debug information will appear here after processing...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mt-4">
            <div class="col-12">
                <button id="exportBtn" class="btn btn-hitachi w-100 d-none">
                    <i class="fas fa-download me-2"></i>Export Hasil ke CSV
                </button>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer mt-4">
            <p class="mb-0">Frederick Simarmata &copy; 2025 - fredericksimarmata@gmail.com</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const fileList = document.getElementById('fileList');
            const fileListContainer = document.getElementById('fileListContainer');
            const processBtn = document.getElementById('processBtn');
            const progressBar = document.getElementById('progressBar');
            const exportBtn = document.getElementById('exportBtn');
            const debugInfo = document.getElementById('debugInfo');
            const filePreviewCard = document.getElementById('filePreviewCard');
            const filePreview = document.getElementById('filePreview');
            const tidValue = document.getElementById('tidValue');
            
            const failedTotal = document.getElementById('failedTotal');
            const failedCount = document.getElementById('failedCount');
            const storedTotal = document.getElementById('storedTotal');
            const storedCount = document.getElementById('storedCount');
            const takenTotal = document.getElementById('takenTotal');
            const takenCount = document.getElementById('takenCount');
            const replenishTotal = document.getElementById('replenishTotal');
            const replenishCount = document.getElementById('replenishCount');
            
            const denom50Total = document.getElementById('denom50Total');
            const denom50Count = document.getElementById('denom50Count');
            const denom50Replenish = document.getElementById('denom50Replenish');
            const denom50Stored = document.getElementById('denom50Stored');
            const denom50Dispense = document.getElementById('denom50Dispense');
            
            const denom100Total = document.getElementById('denom100Total');
            const denom100Count = document.getElementById('denom100Count');
            const denom100Replenish = document.getElementById('denom100Replenish');
            const denom100Stored = document.getElementById('denom100Stored');
            const denom100Dispense = document.getElementById('denom100Dispense');
            
            const remaining50Replenish = document.getElementById('remaining50Replenish');
            const remaining50Stored = document.getElementById('remaining50Stored');
            const remaining50Dispense = document.getElementById('remaining50Dispense');
            const remaining50Total = document.getElementById('remaining50Total');
            
            const remaining100Replenish = document.getElementById('remaining100Replenish');
            const remaining100Stored = document.getElementById('remaining100Stored');
            const remaining100Dispense = document.getElementById('remaining100Dispense');
            const remaining100Total = document.getElementById('remaining100Total');
            
            const calcInitAmount = document.getElementById('calcInitAmount');
            const calcFailed = document.getElementById('calcFailed');
            const calcStored = document.getElementById('calcStored');
            const calcTaken = document.getElementById('calcTaken');
            const calcResult = document.getElementById('calcResult');
            const finalResult = document.getElementById('finalResult');
            
            const transactionDetails = document.getElementById('transactionDetails');
            
            let uploadedFiles = [];
            let results = {
                failed: { total: 0, count: 0, transactions: [] },
                stored: { total: 0, count: 0, transactions: [] },
                taken: { total: 0, count: 0, transactions: [] },
                replenish: { total: 0, count: 0, transactions: [] },
                denom: {
                    replenish50: 0,
                    replenish100: 0,
                    stored50: 0,
                    stored100: 0,
                    dispense50: 0,
                    dispense100: 0
                },
                tid: null
            };
            
            // Upload area functionality
            uploadArea.addEventListener('click', function() {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', function(event) {
                // Reset previous results when new files are selected
                resetResults();
                handleFiles(event.target.files);
            });
            
            // Drag and drop functionality
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--hitachi)';
                uploadArea.style.backgroundColor = '#f0f7ff';
            });
            
            uploadArea.addEventListener('dragleave', function() {
                uploadArea.style.borderColor = '#dee2e6';
                uploadArea.style.backgroundColor = '#f8f9fa';
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = '#dee2e6';
                uploadArea.style.backgroundColor = '#f8f9fa';
                
                if (e.dataTransfer.files.length > 0) {
                    // Reset previous results when new files are dropped
                    resetResults();
                    handleFiles(e.dataTransfer.files);
                }
            });
            
            // Process button
            processBtn.addEventListener('click', processFiles);
            
            // Export button
            exportBtn.addEventListener('click', exportResults);
            
            // Reset all results
            function resetResults() {
                results = {
                    failed: { total: 0, count: 0, transactions: [] },
                    stored: { total: 0, count: 0, transactions: [] },
                    taken: { total: 0, count: 0, transactions: [] },
                    replenish: { total: 0, count: 0, transactions: [] },
                    denom: {
                        replenish50: 0,
                        replenish100: 0,
                        stored50: 0,
                        stored100: 0,
                        dispense50: 0,
                        dispense100: 0
                    },
                    tid: null
                };
                
                // Clear file list
                fileList.innerHTML = '';
                fileListContainer.classList.add('d-none');
                processBtn.classList.add('d-none');
                exportBtn.classList.add('d-none');
                
                // Reset displayed values
                failedTotal.textContent = 'Rp 0';
                failedCount.textContent = '0 transaksi';
                storedTotal.textContent = 'Rp 0';
                storedCount.textContent = '0 transaksi';
                takenTotal.textContent = 'Rp 0';
                takenCount.textContent = '0 transaksi';
                replenishTotal.textContent = 'Rp 0';
                replenishCount.textContent = 'Init Amount ditemukan';
                tidValue.textContent = '-';
                
                denom50Total.textContent = '0';
                denom50Count.textContent = '0 lembar';
                denom50Replenish.textContent = '0';
                denom50Stored.textContent = '0';
                denom50Dispense.textContent = '0';
                
                denom100Total.textContent = '0';
                denom100Count.textContent = '0 lembar';
                denom100Replenish.textContent = '0';
                denom100Stored.textContent = '0';
                denom100Dispense.textContent = '0';
                
                remaining50Replenish.textContent = '0';
                remaining50Stored.textContent = '0';
                remaining50Dispense.textContent = '0';
                remaining50Total.textContent = '0';
                
                remaining100Replenish.textContent = '0';
                remaining100Stored.textContent = '0';
                remaining100Dispense.textContent = '0';
                remaining100Total.textContent = '0';
                
                calcInitAmount.textContent = 'Rp 0';
                calcFailed.textContent = '+ Rp 0';
                calcStored.textContent = '+ Rp 0';
                calcTaken.textContent = '- Rp 0';
                calcResult.textContent = 'Rp 0';
                finalResult.textContent = 'Rp 0';
                
                transactionDetails.innerHTML = '';
                debugInfo.textContent = 'Debug information will appear here after processing...';
            }
            
            // Handle uploaded files
            function handleFiles(files) {
                uploadedFiles = []; // Reset uploaded files array
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (file.name.endsWith('.jrn') || file.name.endsWith('.txt')) {
                        uploadedFiles.push(file);
                        
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        fileItem.innerHTML = `
                            <span class="file-name">${file.name}</span>
                            <span class="file-size">${formatFileSize(file.size)}</span>
                        `;
                        fileList.appendChild(fileItem);
                        
                        // Preview the first file
                        if (i === 0) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                filePreview.textContent = e.target.result;
                                filePreviewCard.classList.remove('d-none');
                            };
                            reader.readAsText(file);
                        }
                    }
                }
                
                if (uploadedFiles.length > 0) {
                    fileListContainer.classList.remove('d-none');
                    processBtn.classList.remove('d-none');
                }
            }
            
            // Process all uploaded files
            function processFiles() {
                // Show progress bar
                progressBar.classList.remove('d-none');
                const progressBarInner = progressBar.querySelector('.progress-bar');
                
                // Clear debug info
                debugInfo.textContent = 'Memproses file...\n';
                
                // Process each file
                let processed = 0;
                uploadedFiles.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const content = e.target.result;
                        debugInfo.textContent += `\nMemproses file: ${file.name}\n`;
                        processFileContent(content, file.name);
                        
                        processed++;
                        const progress = (processed / uploadedFiles.length) * 100;
                        progressBarInner.style.width = `${progress}%`;
                        
                        if (processed === uploadedFiles.length) {
                            // All files processed
                            progressBar.classList.add('d-none');
                            displayResults();
                            exportBtn.classList.remove('d-none');
                        }
                    };
                    reader.readAsText(file);
                });
            }
            
            // Process content of a single file
            function processFileContent(content, fileName) {
                const lines = content.split('\n');
                let debugContent = '';
                
                // Process TID (ATM ID) - only once
                if (results.tid === null) {
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i];
                        if (line.includes('ATM ID :')) {
                            const tidMatch = line.match(/ATM ID :\s*(\d+)/);
                            if (tidMatch && tidMatch[1]) {
                                results.tid = tidMatch[1];
                                debugContent += `✓ Ditemukan ATM ID: ${results.tid}\n`;
                                break;
                            }
                        }
                    }
                }
                
                // Process REPLENISHMENT first (only the first one found)
                let replenishFound = false;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    if (!replenishFound && line.includes('REPLENISHMENT')) {
                        debugContent += `✓ Ditemukan REPLENISHMENT di baris ${i+1}\n`;
                        
                        // For REPLENISHMENT, look for INIT AMOUNT below (within 50 lines)
                        for (let j = i + 1; j < lines.length && j <= i + 50; j++) {
                            if (lines[j].includes('INIT AMOUNT:')) {
                                const amountInfo = extractInitAmountFromLine(lines[j]);
                                if (amountInfo) {
                                    debugContent += `✓ Ditemukan INIT AMOUNT di baris ${j+1}: ${amountInfo.amountRaw} → ${formatCurrency(amountInfo.amount)}\n`;
                                    results.replenish.count = 1; // Hanya hitung 1
                                    results.replenish.total = amountInfo.amount; // Hanya ambil nilai pertama
                                    results.replenish.transactions = [{
                                        file: fileName,
                                        amount: amountInfo.amount,
                                        line: i + 1,
                                        initAmountLine: j + 1
                                    }];
                                    replenishFound = true;
                                    debugContent += `✓ Mengambil nilai REPLENISHMENT pertama: ${formatCurrency(amountInfo.amount)}\n`;
                                }
                            }
                        }
                        
                        // Process REPLENISHMENT lembar (cassette data)
                        if (!replenishFound) {
                            debugContent += `✗ INIT AMOUNT tidak ditemukan setelah REPLENISHMENT\n`;
                        }
                        
                        // Process cassette data for replenish lembar
                        processReplenishLembar(lines, i, debugContent);
                        
                        // Hentikan pencarian REPLENISHMENT setelah menemukan yang pertama
                        break;
                    }
                }
                
                // Process other keywords (Host Store: Failed, Host Store: Stored, Cash Taken)
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    if (line.includes('Host Store: Failed')) {
                        const amount = findAmountAbove(lines, i);
                        if (amount !== null) {
                            results.failed.count++;
                            results.failed.total += amount;
                            results.failed.transactions.push({
                                file: fileName,
                                amount: amount,
                                line: i + 1
                            });
                        }
                    }
                    else if (line.includes('Host Store: Stored')) {
                        const amount = findAmountAbove(lines, i);
                        if (amount !== null) {
                            results.stored.count++;
                            results.stored.total += amount;
                            results.stored.transactions.push({
                                file: fileName,
                                amount: amount,
                                line: i + 1
                            });
                        }
                    }
                    else if (line.includes('Cash Taken')) {
                        const amount = findAmountAbove(lines, i);
                        if (amount !== null) {
                            results.taken.count++;
                            results.taken.total += amount;
                            results.taken.transactions.push({
                                file: fileName,
                                amount: amount,
                                line: i + 1
                            });
                        }
                    }
                }
                
                // Process Stored Count and Dispense Count for denomination counting
                processDenomCounts(lines, fileName, debugContent);
                
                // Update debug info
                debugInfo.textContent += debugContent;
            }
            
            // Process REPLENISHMENT lembar (cassette data)
            function processReplenishLembar(lines, startLine, debugContent) {
                debugContent += `✓ Mencari data cassette setelah REPLENISHMENT\n`;
                
                for (let i = startLine + 1; i < lines.length; i++) {
                    const line = lines[i];
                    
                    // Stop when we reach the separator line
                    if (line.includes('----------------------------------------')) {
                        break;
                    }
                    
                    // Look for cassette data patterns like CASSETTEX   50000 1500
                    const cassetteMatch = line.match(/(CASSETTE\d+)\s+(\d+)\s+(\d+)/);
                    if (cassetteMatch) {
                        const cassette = cassetteMatch[1];
                        const denomValue = parseInt(cassetteMatch[2], 10);
                        const denomCount = parseInt(cassetteMatch[3], 10);
                        
                        debugContent += `✓ Ditemukan ${cassette}: Denom ${denomValue}, Count ${denomCount}\n`;
                        
                        // Bagi nilai count menjadi 2 sesuai instruksi
                        const dividedCount = Math.floor(denomCount / 2);
                        
                        if (denomValue === 50000) {
                            results.denom.replenish50 += dividedCount;
                        } else if (denomValue === 100000) {
                            results.denom.replenish100 += dividedCount;
                        }
                    }
                }
                
                debugContent += `✓ Total Replenish Lembar (setelah dibagi 2): 50,000=${results.denom.replenish50}, 100,000=${results.denom.replenish100}\n`;
            }
            
            // Process Stored Count and Dispense Count for denomination counting
            function processDenomCounts(lines, fileName, debugContent) {
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    // Process Stored Count
                    if (line.includes('Stored Count')) {
                        debugContent += `✓ Ditemukan Stored Count di baris ${i+1}\n`;
                        
                        // Look for denomination data before [Jpr contents]
                        for (let j = i + 1; j < lines.length; j++) {
                            if (lines[j].includes('[Jpr contents]')) {
                                break; // Stop when we reach [Jpr contents]
                            }
                            
                            // Check for denomination patterns like [50000, X] or [100000, X]
                            const denomMatch = lines[j].match(/\[(\d+),\s*(\d+)\]/);
                            if (denomMatch) {
                                const denomValue = parseInt(denomMatch[1], 10);
                                const denomCount = parseInt(denomMatch[2], 10);
                                
                                if (denomValue === 50000) {
                                    results.denom.stored50 += denomCount;
                                    debugContent += `✓ Denom 50,000: ${denomCount} lembar\n`;
                                } else if (denomValue === 100000) {
                                    results.denom.stored100 += denomCount;
                                    debugContent += `✓ Denom 100,000: ${denomCount} lembar\n`;
                                }
                            }
                        }
                    }
                    
                    // Process Dispense Count
                    if (line.includes('Dispense Count')) {
                        debugContent += `✓ Ditemukan Dispense Count di baris ${i+1}\n`;
                        
                        // Look for pattern like [X,X,X,X] after Dispense Count
                        const dispenseMatch = line.match(/Dispense Count\s+\[(\d+),(\d+),(\d+),(\d+)\]/);
                        if (dispenseMatch) {
                            const count1 = parseInt(dispenseMatch[1], 10);
                            const count2 = parseInt(dispenseMatch[2], 10);
                            const count3 = parseInt(dispenseMatch[3], 10);
                            const count4 = parseInt(dispenseMatch[4], 10);
                            
                            // First two values are for 100,000 denomination
                            results.denom.dispense100 += (count1 + count2);
                            
                            // Last two values are for 50,000 denomination
                            results.denom.dispense50 += (count3 + count4);
                            
                            debugContent += `✓ Dispense Count: 100,000=${count1 + count2} lembar, 50,000=${count3 + count4} lembar\n`;
                        }
                    }
                }
            }
            
            // Find AMOUNT value above the current line
            function findAmountAbove(lines, currentLine) {
                // Search upwards from current line
                for (let i = currentLine - 1; i >= 0 && i >= currentLine - 10; i--) {
                    if (lines[i].includes('AMOUNT')) {
                        // Extract numeric value from amount line
                        return extractAmountFromLine(lines[i]);
                    }
                }
                return null;
            }
            
            // Extract amount from a line containing AMOUNT information
            function extractAmountFromLine(line) {
                // Match numbers with optional dots/commas as thousand separators
                const amountMatch = line.match(/(\d[\d.,]*)/);
                if (amountMatch) {
                    // Clean and convert the amount
                    const amountStr = amountMatch[0].replace(/\./g, '').replace(/,/g, '');
                    const amount = parseInt(amountStr, 10);
                    return isNaN(amount) ? null : amount;
                }
                return null;
            }
            
            // Extract amount from a line containing INIT AMOUNT information
            function extractInitAmountFromLine(line) {
                // Match pattern: INIT AMOUNT: [spaces] [amount with dots/commas] [spaces] IDR
                const initAmountMatch = line.match(/INIT AMOUNT:\s*([\d.,]+)\s*IDR/i);
                if (initAmountMatch && initAmountMatch[1]) {
                    // Clean and convert the amount
                    const amountStr = initAmountMatch[1].replace(/\./g, '').replace(/,/g, '');
                    const amount = parseInt(amountStr, 10);
                    if (!isNaN(amount)) {
                        return {
                            amount: amount,
                            amountRaw: initAmountMatch[1]
                        };
                    }
                }
                
                // Alternative pattern: look for numbers between INIT AMOUNT: and IDR
                const alternativeMatch = line.match(/INIT AMOUNT:(.*?)IDR/i);
                if (alternativeMatch && alternativeMatch[1]) {
                    const amountPart = alternativeMatch[1].trim();
                    const amountMatch = amountPart.match(/([\d.,]+)/);
                    if (amountMatch) {
                        const amountStr = amountMatch[0].replace(/\./g, '').replace(/,/g, '');
                        const amount = parseInt(amountStr, 10);
                        if (!isNaN(amount)) {
                            return {
                                amount: amount,
                                amountRaw: amountMatch[0]
                            };
                        }
                    }
                }
                
                // Last resort: extract any number from the line
                const numberMatch = line.match(/(\d[\d.,]*)/);
                if (numberMatch) {
                    const amountStr = numberMatch[0].replace(/\./g, '').replace(/,/g, '');
                    const amount = parseInt(amountStr, 10);
                    if (!isNaN(amount)) {
                        return {
                            amount: amount,
                            amountRaw: numberMatch[0]
                        };
                    }
                }
                
                return null;
            }
            
            // Display results
            function displayResults() {
                // Update TID
                tidValue.textContent = results.tid || '-';
                
                // Update totals
                failedTotal.textContent = formatCurrency(results.failed.total);
                failedCount.textContent = `${results.failed.count} transaksi`;
                
                storedTotal.textContent = formatCurrency(results.stored.total);
                storedCount.textContent = `${results.stored.count} transaksi`;
                
                takenTotal.textContent = formatCurrency(results.taken.total);
                takenCount.textContent = `${results.taken.count} transaksi`;
                
                replenishTotal.textContent = formatCurrency(results.replenish.total);
                replenishCount.textContent = `${results.replenish.count} Init Amount ditemukan`;
                
                // Update denomination results
                const totalDenom50 = results.denom.replenish50 + results.denom.stored50 + results.denom.dispense50;
                const totalDenom100 = results.denom.replenish100 + results.denom.stored100 + results.denom.dispense100;
                
                denom50Total.textContent = totalDenom50;
                denom50Count.textContent = `${totalDenom50} lembar`;
                denom50Replenish.textContent = results.denom.replenish50;
                denom50Stored.textContent = results.denom.stored50;
                denom50Dispense.textContent = results.denom.dispense50;
                
                denom100Total.textContent = totalDenom100;
                denom100Count.textContent = `${totalDenom100} lembar`;
                denom100Replenish.textContent = results.denom.replenish100;
                denom100Stored.textContent = results.denom.stored100;
                denom100Dispense.textContent = results.denom.dispense100;
                
                // Update remaining results
                const remaining50 = results.denom.replenish50 + results.denom.stored50 - results.denom.dispense50;
                const remaining100 = results.denom.replenish100 + results.denom.stored100 - results.denom.dispense100;
                
                remaining50Replenish.textContent = results.denom.replenish50;
                remaining50Stored.textContent = results.denom.stored50;
                remaining50Dispense.textContent = results.denom.dispense50;
                remaining50Total.textContent = remaining50;
                
                remaining100Replenish.textContent = results.denom.replenish100;
                remaining100Stored.textContent = results.denom.stored100;
                remaining100Dispense.textContent = results.denom.dispense100;
                remaining100Total.textContent = remaining100;
                
                // Update calculation table
                calcInitAmount.textContent = formatCurrency(results.replenish.total);
                calcFailed.textContent = `+ ${formatCurrency(results.failed.total)}`;
                calcStored.textContent = `+ ${formatCurrency(results.stored.total)}`;
                calcTaken.textContent = `- ${formatCurrency(results.taken.total)}`;
                
                // Calculate final result
                const finalAmount = results.replenish.total + results.failed.total + results.stored.total - results.taken.total;
                calcResult.textContent = formatCurrency(finalAmount);
                finalResult.textContent = formatCurrency(finalAmount);
                
                // Update transaction details
                transactionDetails.innerHTML = '';
                
                // Add replenishment transactions (only the first one)
                results.replenish.transactions.forEach(trans => {
                    addTransactionRow('replenish', trans.file, trans.amount, trans.line, trans.initAmountLine);
                });
                
                // Add failed transactions
                results.failed.transactions.forEach(trans => {
                    addTransactionRow('failed', trans.file, trans.amount, trans.line);
                });
                
                // Add stored transactions
                results.stored.transactions.forEach(trans => {
                    addTransactionRow('stored', trans.file, trans.amount, trans.line);
                });
                
                // Add taken transactions
                results.taken.transactions.forEach(trans => {
                    addTransactionRow('taken', trans.file, trans.amount, trans.line);
                });
                
                // Update debug info with final results
                debugInfo.textContent += `\n=== HASIL AKHIR ===\n`;
                debugInfo.textContent += `ATM ID: ${results.tid || 'Tidak ditemukan'}\n`;
                debugInfo.textContent += `Replenishment: ${formatCurrency(results.replenish.total)} (hanya nilai pertama)\n`;
                debugInfo.textContent += `Host Store Failed: ${formatCurrency(results.failed.total)}\n`;
                debugInfo.textContent += `Host Store Stored: ${formatCurrency(results.stored.total)}\n`;
                debugInfo.textContent += `Cash Taken: ${formatCurrency(results.taken.total)}\n`;
                debugInfo.textContent += `Replenish Lembar (setelah dibagi 2) - 50,000: ${results.denom.replenish50}, 100,000: ${results.denom.replenish100}\n`;
                debugInfo.textContent += `Stored Count - 50,000: ${results.denom.stored50}, 100,000: ${results.denom.stored100}\n`;
                debugInfo.textContent += `Dispense Count - 50,000: ${results.denom.dispense50}, 100,000: ${results.denom.dispense100}\n`;
                debugInfo.textContent += `Sisa Lembar - 50,000: ${remaining50}, 100,000: ${remaining100}\n`;
                debugInfo.textContent += `Hasil Rekonsiliasi: ${formatCurrency(finalAmount)}\n`;
            }
            
            // Add transaction row to details table
            function addTransactionRow(type, file, amount, line, initAmountLine = null) {
                const row = document.createElement('tr');
                
                let typeBadge = '';
                if (type === 'failed') {
                    typeBadge = '<span class="badge bg-danger">Failed</span>';
                } else if (type === 'stored') {
                    typeBadge = '<span class="badge bg-success">Stored</span>';
                } else if (type === 'taken') {
                    typeBadge = '<span class="badge bg-primary">Taken</span>';
                } else if (type === 'replenish') {
                    typeBadge = '<span class="badge bg-purple">Replenish</span>';
                }
                
                const lineInfo = initAmountLine ? `REPL: ${line}, INIT: ${initAmountLine}` : line;
                
                row.innerHTML = `
                    <td>${typeBadge}</td>
                    <td>${file}</td>
                    <td>${lineInfo}</td>
                    <td>${formatCurrency(amount)}</td>
                `;
                
                transactionDetails.appendChild(row);
            }
            
            // Export results to CSV
            function exportResults() {
                let csvContent = 'Jenis,File,Line,Amount\n';
                
                // Add replenishment transactions (only the first one)
                results.replenish.transactions.forEach(trans => {
                    csvContent += `REPLENISHMENT,${trans.file},${trans.line},${trans.amount}\n`;
                });
                
                // Add failed transactions
                results.failed.transactions.forEach(trans => {
                    csvContent += `Host Store: Failed,${trans.file},${trans.line},${trans.amount}\n`;
                });
                
                // Add stored transactions
                results.stored.transactions.forEach(trans => {
                    csvContent += `Host Store: Stored,${trans.file},${trans.line},${trans.amount}\n`;
                });
                
                // Add taken transactions
                results.taken.transactions.forEach(trans => {
                    csvContent += `Cash Taken,${trans.file},${trans.line},${trans.amount}\n`;
                });
                
                // Add denomination summary
                csvContent += '\n';
                csvContent += 'DENOMINATION SUMMARY\n';
                csvContent += 'Type,Denom 50,000,Denom 100,000\n';
                csvContent += `Replenish Lembar (setelah dibagi 2),${results.denom.replenish50},${results.denom.replenish100}\n`;
                csvContent += `Stored Count,${results.denom.stored50},${results.denom.stored100}\n`;
                csvContent += `Dispense Count,${results.denom.dispense50},${results.denom.dispense100}\n`;
                csvContent += `Sisa Lembar,${results.denom.replenish50 + results.denom.stored50 - results.denom.dispense50},${results.denom.replenish100 + results.denom.stored100 - results.denom.dispense100}\n`;
                
                // Add TID information
                csvContent += '\n';
                csvContent += `ATM ID,${results.tid || 'Tidak ditemukan'}\n`;
                
                // Add summary
                csvContent += '\n';
                csvContent += `REPLENISHMENT Total,,,${results.replenish.total}\n`;
                csvContent += `Host Store: Failed Total,,,${results.failed.total}\n`;
                csvContent += `Host Store: Stored Total,,,${results.stored.total}\n`;
                csvContent += `Cash Taken Total,,,${results.taken.total}\n`;
                csvContent += `Final Result,,,${results.replenish.total + results.failed.total + results.stored.total - results.taken.total}\n`;
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', 'hasil_rekon_crm_hitachi.csv');
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            // Format file size
            function formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' bytes';
                else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
                else return (bytes / 1048576).toFixed(1) + ' MB';
            }
            
            // Format currency
            function formatCurrency(amount) {
                return 'Rp ' + new Intl.NumberFormat('id-ID').format(amount);
            }
        });
    </script>
</body>
</html>
